:uri:
:toc: manual
:toc-placement: preamble
:numbered:
:rulesspreadsheet: link:https://docs.google.com/spreadsheets/d/1C4jbSADmHJvLL3PBBBSEB54L8G_I6NN5rblWIGymAXg/edit#gid=1640119171[GPTE Accreditation Rules Spreadsheet with validation]
:designdoc: link:https://docs.google.com/document/d/1rFioqj5uhLtdoUEfHHBEwh4_-bW7vqEc5N0R24tN9FU/edit#[GPTE Reporting design document]

= GPTE Reporting

Administration Guide


== Overview

=== Purpose and design
High level purpose and system design of the `GPTE Reporting` project can be found in the  {designdoc} (best viewed in Google Chrome).

=== Audience
The intended audience of this document architects, developers and administrators of the GPTE Reporting solution.

== Pre-Reqs

=== Technical

. Github account with, at a minimum, `viewer` credentials to the `github.com/redhat-gpe` organization
. Workstation (bare metal or VM) with 8GB RAM, 4 CPUs and 100GB disk

=== Skills

. RHCSA or equivalent experience.
. Experience with Git.
. Experience with Java development and its defacto build tool: Maven.
. Experience with JBoss EAP administration.
. Experience developing services using JBoss Fuse.
. Experience with the Drools and Dashbuilder components of JBoss BPMS.
. Experience with database development and administration using MariaDB.

== Administration

=== Operating System
. Ensure that a `jboss` operating system user (with groupId = 100) exists.
. As root:  chown -R jboss:100 /opt
. Install mysql JDBC :
+
-----
yum install -y mysql-connector-java.noarch
-----
. Install JDK 8 :
+
-----
yum install java-1.8.0-openjdk-devel.x86_64
-----
. Install mariadb-server :
+
-----
yum install mariadb-server
-----

==== Maven

Maven is the build tool used by GPTE Reporting solution.

RHEL based package repositories tend to provide older (buggy) versions of Maven.

Manually install the latest maven from:  `maven.apache.org`.

Ensure that the downloaded version of Maven is on the $PATH of both the `jboss` and `root` operating system users.

=== OPEN_Reporting project
Execute everything in this section as the `jboss` operating system user.

==== Clone
The source code of the `GPTE Reporting` solution is maintained in private github organization at: `github.com/redhat-gpe`.

Execute the following:

-----
git clone https://github.com/redhat-gpe/OPEN_Reporting.git
-----

The above command will prompt you for your github userId and password.
Ensure that you provide your github userId that has at least `viewer` credentials to the `github.com/redhat-gpe` organization.

NOTE: For the purposes of this project, the term `$PROJECT_HOME` refers to the following directory: `/path/to/cloned/OPEN_Reporting/`

==== Build

-----
cd $PROJECT_HOME
mvn clean install -DskipTests
-----

=== MySQL

. Ensure the most recent version of the `mariadb-server` package is installed on your RHEL7 operating system.
+
-----
# yum install -y mariadb-server
-----

. Enable and start the `mariadb-server` as an operating system service.
+
-----
# systemctl enable mariadb-server.service
# systemctl start mariadb-server.service
-----

. Log into the `mysql` database of the MariaDB RDBMS and create the following databases:
+
-----
create database dashbuilder;
create database lms_reporting;
create database lms_transactional;
-----

. Create database users and affiliate to databases:
+
-----
grant all on mysql.* to 'root'@'%' identified by 'c-9XSHln8hJ_UH9YvNOgc9mH';
grant all on dashbuilder.* to 'dashbuilder'@'localhost' identified by 'dashbuilder';
grant all on lms_reporting.* to 'lms_report'@'localhost' identified by 'lms_report';
grant all on lms_transactional.* to 'lms_trans'@'localhost' identified by 'lms_trans';
-----

. Seed the `lms_transactional` database with test data
+
-----
mysql -u root -p mysql <  db_scripts/lms_transactional_ddl.sql
mysql -u lms_trans -pc-9XSHln8hJ_UH9YvNOgc9mH lms_transactional < db_scripts/lms_transactional_data.sql
-----

. Periodically, create a new test datafile from a current snapshot of your `lms_transactional` database:
+
-----
mysql -u root -pc-9XSHln8hJ_UH9YvNOgc9mH mysql -e "use lms_transactional; delete from lms_transactional.Students where StudentID > 10399"
mysqldump --no-create-db --no-create-info -u lms_trans -p'c-9XSHln8hJ_UH9YvNOgc9mH' lms_transactional > db_scripts/lms_transactional_data.sql
-----

=== JBoss Fuse on EAP

==== installation and configuration

NOTE: Execute all of the following as the `jboss` operating system user.

. Download the following from the Red Hat Support Portal:
.. *jboss-eap-6.4.4-full-build.zip*
.. *fuse-eap-installer-6.2.1.redhat-084.jar*
. unzip JBoss EAP into: `/opt/jboss/eap`
+
NOTE: For the purpose of this admin guide, the term `$JBOSS_HOME` will refer to the following path: `/opt/jboss/eap/jboss-eap-6.4`.
. Change directories into: $JBOSS_HOME
. java -jar /path/to/fuse-eap-installer-6.2.1.redhat-084.jarfuse-eap-installer-6.2.1.redhat-412.jar

. Create `com.mysql.jdbc` JBoss module
+
----
cd $JBOSS_HOME
cp -r $PROJECT_HOME/config/modules/* modules
cd modules/system/layers/base/com/mysql/jdbc/main
ln -sf  /usr/share/java/mysql-connector-java.jar modules/system/layers/base/com/mysql/jdbc/main/mysql-connector-java.jar
----

. Modify JBoss start-up JAVA_OPTS :
+
-----
cp $PROJECT_HOME/config/bin/standalone.conf $JBOSS_HOME/bin
-----

. Execute JBoss CLI based changes
.. Start JBoss EAP in `admin-mode`:
+
-----
./bin/standalone.sh -c standalone.xml --admin-only
-----
.. In another terminal window (again as the `jboss` operating system user), change directories to `$PROJECT_HOME`.
.. Execute :
+
-----
$JBOSS_HOME/bin/jboss-cli.sh -c --file=config/cli/eap-configs.cli
-----

==== Enable as an OS service
Execute the following as the `root` operating system user:

. Configure the service
.. cp $PROJECT_HOME/config/service/gpte-integration.service /usr/lib/systemd/system
.. Then enable the service
+
-----
sudo systemctl enable gpte-integration.service
-----

. start
+
-----
sudo systemctl start gpte-integration.service
-----

. check log
+
-----
sudo journalctl -u gpte-integration -f
-----

==== Gain access to `JBoss Command Line Interface`:
+
-----
$JBOSS_HOME/bin/jboss-cli.sh --controller=localhost:10124 --connect
-----

=== activemq-artemis install

-----
# sudo yum install -y libaio-devel
# sudo su - jboss
$ cd /opt
$ git clone https://github.com/apache/activemq-artemis.git
$ cd activemq-artemis
$ mvn -Prelease install -DskipTests
$ cd artemis-distribution/target/apache-artemis-1.4.0-SNAPSHOT-bin/apache-artemis-1.4.0-SNAPSHOT

-----

=== Hawtio Admin Console
The `Hawtio` admin console can be reached by navigating to the following URL using your browser:

-----
http://docker1.ose.opentlc.com:8205/hawtio/http://docker1.ose.opentlc.com:8205/hawtio/
-----

NOTE: hawtio web app presents the `white screen of death` until all javascript client libraries have been downloaded.
The size of this client side download is about 5.5MBs.
Use a browser tool such as `Firebug` to monitor download progress of these client side libraries to your browser.

Login using the following credentials: `admin / jb0ssredhat!`


== GPTE Reporting Routing Process

GPTE Reporting includes a service called: `gpte_universal_process`.
This service executes within JBoss Fuse on EAP and its purpose is the following:

. Consume data feeds sent to GPTE Reporting from external systems and users.
+
Examples include course completions from Dokeos and student registration data from Sumtotal.
+
This service consumes data files from a variety of endpoints such as email and local filesystem.
. Light validation of the data file (ie: proper sender email account and correct file suffix).
. Route the datafile for further processing to one of the other GPTE Reporting services also residing in the same JBoss Fuse on EAP JVM.

=== Filesystem
The GPTE Reporting `universal` process consumes student registration and course completion datafiles directly from the filesystem.

Subsequently, student registration and/or course completion datafiles can be uploaded to the following directory on the filesystem where JBoss Fuse on EAP is running:

-----
/tmp/gpte/inbox-for-emails
-----

=== Email
Allow camel email component to connect to gmail .

. Execute steps #2 and #3 for the following gmail accounts:
* *rht.gpte.sb.test@gmail.com*
* *gpeskills@gmail.com*

. Open your browser, authenticate into gmail and navigate to the following site:
+
-----
https://myaccount.google.com/security#connectedapps
-----
. Set value of `Allow less secure apps` to `On`
+
image::skillsbase_integration/doc/images/gmail_settings.png[]

== Student Registration Process

=== GPTE IPA integration

== Course Completion Process

== Accreditation Process

The GPTE Reporting service is a stand-alone (it does not run in JBoss EAP), Camel based, Java process.

Its purpose is to :

. Parse and validate GPTE accreditation rules (in tab-delimited spreadsheet format) into Drools Rule Language (DRL) format.
. Determine accreditations based on student's course completions.
+
In particular, the `accred-process` background job periodically determines new accreditations based on new course completions that have entered the system during that time period.


=== Start Accreditation Process

-----
sudo cp $PROJECT_HOME/config/service/accred-process.service /usr/lib/systemd/system
sudo systemctl enable accred-process.service
sudo systemctl restart accred-process.service
sudo systemctl status accred-process.service
-----

=== Monitor Accreditation Process log

-----
sudo journalctl -u accred-process -f
-----

=== Execute Rules Spreadsheet Validation and Parsing to DRL

. SSH into GPTE Reporting operating system as the `jboss` operating system user:
. Change directories to OPEN_Reporting
. Ensure that `accred-process` JVM is running.
. Download `DCI`, `MW` and `CI` tabs from {rulesspreadsheet}
.. For all three spreadsheet tabs, navigate to `File -> Download As -> Tab Separated Value (.tsv, current sheet)
.. Save all three spreadsheets to your local file system, ie:  $HOME/Downloads
. Secure copy latest *.tsv files to dev environment at: `dev.opentlc.com`
+
-----
scp $HOME/Downloads/*.tsv jboss@dev,opentlc.com:/tmp/gpte/inbox-for-rules-spreadsheets
-----

. Monitor the `accred-process` log file for errors.

=== Invoke accreditation logic REST service
By default, the `accred-process` service runs as a background job that periodically determines accreditations.

The `accred-process` service allows also allows for manual triggering of accreditation logic processing on one or more students.

==== Full Accreditation Refresh
This approach will delete all existing accreditations in the `StudentAccreditations` table.

It will then re-calculate all accreditations for all students based on their existing course completions.

. SSH into GPTE Reporting operating as the `jboss` operating system user.
. Change directories to OPEN_Reporting
. Ensure that `accred-process` JVM is running.
. Execute:
+
-----
./bin/accreditation_batch_evaluation.sh -env=[prod | dev]
-----

==== Focused Accreditation Refresh

. Invoke accreditation logic on an existing student whose course completions should lead to an accreditation
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "TEST_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                http://$HOSTNAME:9090/gpte_accreditation/students/10387
-----

. Invoke accreditation logic on a non existent student
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "TEST_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                http://$HOSTNAME:9090/gpte_accreditation/students/103899
-----

. Invoke accreditation logic on all students whose studentid > 10000 and < 11000
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "TEST_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                -H "LOW_STUDENT_ID: 10000" \
                -H "HIGH_STUDENT_ID: 11000" \
                http://$HOSTNAME:9090/gpte_accreditation/students/batch
-----

ifdef::showscript[]
endif::showscript[]
