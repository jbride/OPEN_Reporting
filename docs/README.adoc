:uri:
:toc: manual
:toc-placement: preamble
:numbered:
:rulesspreadsheet: link:https://docs.google.com/spreadsheets/d/1C4jbSADmHJvLL3PBBBSEB54L8G_I6NN5rblWIGymAXg/edit#gid=1640119171[GPTE Accreditation Rules Spreadsheet with validation]
:designdoc: link:https://docs.google.com/document/d/1rFioqj5uhLtdoUEfHHBEwh4_-bW7vqEc5N0R24tN9FU/edit#[GPTE Reporting design document]

= GPTE Reporting

Administration Guide


== Overview

=== Purpose and design
High level purpose and system design of the `GPTE Reporting` project can be found in the  {designdoc} (best viewed in Google Chrome).

=== Audience
The intended audience of this document architects, developers and administrators of the GPTE Reporting solution.

== Pre-Reqs

=== Technical

. Github account with, at a minimum, `viewer` credentials to the `github.com/redhat-gpe` organization
. Workstation (bare metal or VM) with 8GB RAM, 4 CPUs and 100GB disk

=== Skills

. RHCSA or equivalent experience.
. Experience with Ansible
. Experience with Git.
. Experience with Java development and its defacto build tool: Maven.
. Experience with JBoss EAP administration.
. Experience developing services using JBoss Fuse.
. Experience with the Drools and Dashbuilder components of JBoss BPMS.
. Experience with database development and administration using MariaDB.

== Administration

=== Operating System
. Ensure that a `jboss` operating system user (with groupId = 100) exists.
. As root:  chown -R jboss:100 /opt
. Install mysql JDBC :
+
-----
yum install -y mysql-connector-java.noarch
-----
. Install JDK 8 :
+
-----
yum install java-1.8.0-openjdk-devel.x86_64
-----
. Install mariadb-server :
+
-----
yum install mariadb-server
-----

==== Maven

Maven is the build tool used by GPTE Reporting solution.

RHEL based package repositories tend to provide older (buggy) versions of Maven.

Manually install the latest maven from:  `maven.apache.org`.

Ensure that the downloaded version of Maven is on the $PATH of both the `jboss` and `root` operating system users.

=== OPEN_Reporting project
Execute everything in this section as the `jboss` operating system user.

==== Clone
The source code of the `GPTE Reporting` solution is maintained in private github organization at: `github.com/redhat-gpe`.

Execute the following:

-----
git clone https://github.com/redhat-gpe/OPEN_Reporting.git
-----

The above command will prompt you for your github userId and password.
Ensure that you provide your github userId that has at least `viewer` credentials to the `github.com/redhat-gpe` organization.

NOTE: For the purposes of this project, the term `$PROJECT_HOME` refers to the following directory: `/path/to/cloned/OPEN_Reporting/`

==== Build

-----
cd $PROJECT_HOME
mvn clean install -DskipTests
-----

=== MySQL

. Seed the `lms_transactional` database with test data
+
-----
mysql -u root -p mysql <  db_scripts/lms_transactional_ddl.sql
mysql -u root lms_transactional < db_scripts/lms_transactional_data.sql
-----

. Periodically, create a new test datafile from a current snapshot of your `lms_transactional` database:
+
-----
mysql -u root mysql -e "use lms_transactional; delete from lms_transactional.Students where StudentID > 10399"
mysqldump --no-create-db --no-create-info -u root lms_transactional > db_scripts/lms_transactional_data.sql
-----

=== JBoss Fuse on EAP

==== Gain access to `JBoss Command Line Interface`:
+
-----
$JBOSS_HOME/bin/jboss-cli.sh --controller=localhost:10124 --connect
-----

=== activemq-artemis install

-----
# sudo yum install -y libaio-devel
# sudo su - jboss
$ cd /opt
$ git clone https://github.com/apache/activemq-artemis.git
$ cd activemq-artemis
$ mvn -Prelease install -DskipTests
$ cd artemis-distribution/target/apache-artemis-1.4.0-SNAPSHOT-bin/apache-artemis-1.4.0-SNAPSHOT

-----


== GPTE Reporting Routing Process

GPTE Reporting includes a service called: `gpte_universal_process`.
This service executes within JBoss Fuse on EAP and its purpose is the following:

. Consume data feeds sent to GPTE Reporting from external systems and users.
+
Examples include course completions from Dokeos and student registration data from Sumtotal.
+
This service consumes data files from a variety of endpoints such as email and local filesystem.
. Light validation of the data file (ie: proper sender email account and correct file suffix).
. Route the datafile for further processing to one of the other GPTE Reporting services also residing in the same JBoss Fuse on EAP JVM.

=== Filesystem
The GPTE Reporting `universal` process consumes student registration and course completion datafiles directly from the filesystem.

Subsequently, student registration and/or course completion datafiles can be uploaded to the following directory on the filesystem where JBoss Fuse on EAP is running:

-----
/tmp/gpte/inbox-for-emails
-----

=== Email
Allow camel email component to connect to gmail .

. Execute steps #2 and #3 for the following gmail accounts:
* *rht.gpte.sb.test@gmail.com*
* *gpeskills@gmail.com*

. Open your browser, authenticate into gmail and navigate to the following site:
+
-----
https://myaccount.google.com/security#connectedapps
-----
. Set value of `Allow less secure apps` to `On`
+
image::skillsbase_integration/doc/images/gmail_settings.png[]

== Student Registration Process

=== GPTE IPA integration

== Course Completion Process

== Accreditation Process

The GPTE Reporting service is a stand-alone (it does not run in JBoss EAP), Camel based, Java process.

Its purpose is to :

. Parse and validate GPTE accreditation rules (in tab-delimited spreadsheet format) into Drools Rule Language (DRL) format.
. Determine accreditations based on student's course completions.
+
In particular, the `accred-process` background job periodically determines new accreditations based on new course completions that have entered the system during that time period.


=== Start Accreditation Process

-----
sudo cp $PROJECT_HOME/config/service/accred-process.service /usr/lib/systemd/system
sudo systemctl enable accred-process.service
sudo systemctl restart accred-process.service
sudo systemctl status accred-process.service
-----

=== Monitor Accreditation Process log

-----
sudo journalctl -u accred-process -f
-----

=== Execute Rules Spreadsheet Validation and Parsing to DRL

. SSH into GPTE Reporting operating system as the `jboss` operating system user:
. Change directories to OPEN_Reporting
. Ensure that `accred-process` JVM is running.
. Download `DCI`, `MW` and `CI` tabs from {rulesspreadsheet}
.. For all three spreadsheet tabs, navigate to `File -> Download As -> Tab Separated Value (.tsv, current sheet)
.. Save all three spreadsheets to your local file system, ie:  $HOME/Downloads
. Secure copy latest *.tsv files to dev environment at: `dev.opentlc.com`
+
-----
scp $HOME/Downloads/*.tsv jboss@dev,opentlc.com:/tmp/gpte/inbox-for-rules-spreadsheets
-----

. Monitor the `accred-process` log file for errors.

=== Invoke accreditation logic REST service
By default, the `accred-process` service runs as a background job that periodically determines accreditations.

The `accred-process` service allows also allows for manual triggering of accreditation logic processing on one or more students.

==== Full Accreditation Refresh
This approach will delete all existing accreditations in the `StudentAccreditations` table.

It will then re-calculate all accreditations for all students based on their existing course completions.

. SSH into GPTE Reporting operating as the `jboss` operating system user.
. Change directories to OPEN_Reporting
. Ensure that `accred-process` JVM is running.
. Execute:
+
-----
./bin/accreditation_batch_evaluation.sh -env=[prod | dev]
-----

==== Focused Accreditation Refresh

. Invoke accreditation logic on an existing student whose course completions should lead to an accreditation
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "IDENTIFY_FIRED_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                http://$HOSTNAME:9090/gpte_accreditation/students/10387
-----

. Invoke accreditation logic on a non existent student
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "IDENTIFY_FIRED_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                http://$HOSTNAME:9090/gpte_accreditation/students/103899
-----

. Invoke accreditation logic on all students whose studentid > 10000 and < 11000
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "IDENTIFY_FIRED_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                -H "LOW_STUDENT_ID: 10000" \
                -H "HIGH_STUDENT_ID: 11000" \
                http://$HOSTNAME:9090/gpte_accreditation/students/batch
-----

== SkillsBase Integration

. Check # of Red Hat associates whose accreds need to be pushed to SkillsBase
+
-----
MariaDB [lms_transactional]> select count(sa.studentId) from StudentAccreditations sa, Students s where sa.Processed=0 and s.StudentId=sa.StudentID and s.email like "%redhat.com";
-----

. Prepare for end-to-end test using only student = gpse.training+1@redhat.com
+
-----
MariaDB [lms_transactional]>  update StudentAccreditations sa, Students s set sa.Processed=1 where s.StudentId=sa.StudentID and s.email like "%redhat.com";
MariaDB [lms_transactional]>  update StudentAccreditations sa, Students s set sa.Processed=0 where s.StudentId=sa.StudentID and s.email="gpse.training+1@redhat.com";
MariaDB [lms_transactional]>  update Students set SkillsbaseStatus=1 where Email like "%redhat.com";
MariaDB [lms_transactional]>  update Students set SkillsbaseStatus=0 where Email="gpse.training+1@redhat.com";

properties/dev.properties :  
    sb_sendMailToStudentEnabled=true
    accred_process-push-qualification-to-skillsbase-batch=quartz2://accred_process-push-qualifications-to-skillsbase?cron=0 0/5 * 1/1 * ? *

ba
ta
-----


ifdef::showscript[]
endif::showscript[]
