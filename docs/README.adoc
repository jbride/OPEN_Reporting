:uri:
:toc: manual
:toc-placement: preamble
:numbered:
:rulesspreadsheet: link:https://docs.google.com/spreadsheets/d/1C4jbSADmHJvLL3PBBBSEB54L8G_I6NN5rblWIGymAXg/edit#gid=1640119171[GPTE Accreditation Rules Spreadsheet with validation]
:designdoc: link:https://docs.google.com/document/d/1rFioqj5uhLtdoUEfHHBEwh4_-bW7vqEc5N0R24tN9FU/edit#[GPTE Reporting design document]

= GPTE Reporting

Administration Guide


== Overview

=== Purpose and design
High level purpose and system design of the `GPTE Reporting` project can be found in the  {designdoc} (best viewed in Google Chrome).

=== Audience
The intended audience of this document architects, developers and administrators of the GPTE Reporting solution.

== Pre-Reqs

=== Technical

. Github account with, at a minimum, `viewer` credentials to the `github.com/redhat-gpe` organization
. Workstation (bare metal or VM) with 8GB RAM, 4 CPUs and 100GB disk

=== Skills

. RHCSA or equivalent experience.
. Experience with Ansible
. Experience with Git.
. Experience with Java development and its defacto build tool: Maven.
. Experience with JBoss EAP administration.
. Experience developing services using JBoss Fuse.
. Experience with the Drools and Dashbuilder components of JBoss BPMS.
. Experience with database development and administration using MariaDB.

== GPTE Reporting URLs

GPTE Reporting has three environments:  prod, qa and dev.

FQDN of each environment is as follows:

. *prod* :   reporting.opentlc.com
. *qa*   :   qa.opentlc.com
. *dev*  :   dev.opentlc.com

Each of these environments runs the same GPTE Reporting services.


URLs to each GPTE Reporting service are as follows:

. *Dashbuilder* :  https://<fqdn>/dashbuilder


== Provisioning
Review `base_install.yml` and `update.yml` scripts in _$PROJECT_HOME/infrastructure/ansible_ directory.

== Administration

=== Manual Build

-----
cd $PROJECT_HOME
mvn clean install -DskipTests
-----

=== Manual tasks to _lms_transactional_ database

. Seed the `lms_transactional` database with test data
+
-----
mysql -u root lms_transactional <  db_scripts/lms_transactional_ddl.sql
mysql -u root lms_transactional < db_scripts/lms_transactional_data.sql
-----

. Periodically, create a new test datafile from a current snapshot of your `lms_transactional` database.
+
This database is used to support development and unit testing of GPTE Reporting project:
+
-----
# slim down size of lms_transactional database 
mysql -u root lms_transactional -e "delete from Students where StudentID > 10399"

# Data dump to a file
mysqldump --no-create-db --no-create-info -u root lms_transactional > db_scripts/lms_transactional_data.sql

# Dump of lms_transactional schema
mysqldump -d -u root lms_transactional > db_scripts/lms_transactional_ddl.sql
-----

. Export Courses and Mappings as tsv for upload into Accreditation Rules Spreadsheet
+
-----
echo 'select cm.PrunedCourseId, c.CourseId, c.CourseName from Courses c left join CourseMappings cm on cm.courseId = c.courseId' | mysql -u root -p -B lms_transactional > /tmp/Courses_\&_Mappings.tsv
-----


=== JBoss Fuse on EAP

==== Gain access to `JBoss Command Line Interface`:
+
-----
$JBOSS_HOME/bin/jboss-cli.sh --controller=localhost:10124 --connect
-----

== Refresh Course Completions

. Make changes to the _Courses & Mappings_ sheet of {rulesspreadsheet}.
+
NOTE: Not every courseId is going to have a corresponding mapping.
For those courses without a mapping, the _PrunedCourseId can either have a value of `NULL` or can be blank.

. File -> Download As -> Tab-separated values (*.tsv, current sheet)
. Using your Red Hat email account, create an email with the following:
.. *To*:  rhtgptetest@yahoo.com
.. *Subject*: Course Refresh
.. *Attachment*: attached previously downloaded tsv.
. Tail log of GPTE Reporting server of  development environment.
. Send email
. Expects results similar to the following in the log file:
+
-----
imaps://imap.mail.yahoo.com) Received file from: [<jbride@redhat.com>, <jbride@redhat.com>], subject course refresh
imaps://imap.mail.yahoo.com) moveAttachmentsToBodyAndSendToGPTEProcessingRoute() received the following # of attachments: 1
imaps://imap.mail.yahoo.com) determineAttachmentType() attachment type = course_mappings_spreadsheet
vm://cc_process-new-courses-and-mappings-uri) Following # of records deleted from Course and CourseMappings tables: 89 :  0
vm://cc_process-new-courses-and-mappings-uri) insertIntoCourseAndMappings() no mapping found for: CLI-DEL-ADCM-5593-AST
vm://cc_process-new-courses-and-mappings-uri) insertIntoCourseAndMappings() no mapping found for: MWS-DEL-ADEI-1626-AST
vm://cc_process-new-courses-and-mappings-uri) insertIntoCourseAndMappings() no mapping found for: MWS-DEL-ADMOB-7543-AST
vm://cc_process-new-courses-and-mappings-uri) Just refreshed Course and CourseMappings using the following # of records:  453
-----

== GPTE Reporting Routing Process

GPTE Reporting includes a service called: `gpte_shared_process`.
This service executes within JBoss Fuse on EAP and its purpose is the following:

. Consume data feeds sent to GPTE Reporting from external systems and users.
+
Examples include course completions from Dokeos and student registration data from Sumtotal.
+
This service consumes data files from a variety of endpoints such as email and local filesystem.
. Light validation of the data file (ie: proper sender email account and correct file suffix).
. Route the datafile for further processing to one of the other GPTE Reporting services also residing in the same JBoss Fuse on EAP JVM.

=== Filesystem
The GPTE Reporting `universal` process consumes student registration and course completion datafiles directly from the filesystem.

Subsequently, student registration and/or course completion datafiles can be uploaded to the following directory on the filesystem where JBoss Fuse on EAP is running:

-----
/tmp/gpte/inbox-for-emails
-----

=== Email
Allow camel email component to connect to gmail .

. Execute steps #2 and #3 for the following gmail accounts:
* *rht.gpte.sb.test@gmail.com*
* *gpeskills@gmail.com*

. Open your browser, authenticate into gmail and navigate to the following site:
+
-----
https://myaccount.google.com/security#connectedapps
-----
. Set value of `Allow less secure apps` to `On`
+
image::skillsbase_integration/doc/images/gmail_settings.png[]

== Student Registration Process

=== GPTE IPA integration

== Course Completion Process

== Accreditation Process

The GPTE Reporting service is a stand-alone (it does not run in JBoss EAP), Camel based, Java process.

Its purpose is to :

. Parse and validate GPTE accreditation rules (in tab-delimited spreadsheet format) into Drools Rule Language (DRL) format.
. Determine accreditations based on student's course completions.
+
In particular, the `accred-process` background job periodically determines new accreditations based on new course completions that have entered the system during that time period.


=== Start Accreditation Process

Shell aliases have been provided to easily bounce all GPTE Reporting services.

Take a look at the aliases found in:  `/etc/bashrc`.

=== Monitor Accreditation Process log

Shell aliases have been provided to easily tail log files of all GPTE Reporting services.

Take a look at the aliases found in:  `/etc/bashrc`.

=== Execute Rules Spreadsheet Validation and Parsing to DRL

. SSH into GPTE Reporting operating system as the `jboss` operating system user:
. Change directories to OPEN_Reporting
. Ensure that `accred-process` JVM is running.
. Download `DCI`, `MW` and `CI` tabs from {rulesspreadsheet}
.. For all three spreadsheet tabs, navigate to `File -> Download As -> Tab Separated Value (.tsv, current sheet)
.. Save all three spreadsheets to your local file system, ie:  $HOME/Downloads
. Secure copy latest *.tsv files to dev environment at: `dev.opentlc.com`
+
-----
scp $HOME/Downloads/*.tsv jboss@dev,opentlc.com:/tmp/gpte/inbox-for-rules-spreadsheets
-----

. Monitor the `accred-process` log file for errors.

=== Invoke accreditation logic REST service
By default, the `accred-process` service runs as a background job that periodically determines accreditations.

The `accred-process` service allows also allows for manual triggering of accreditation logic processing on one or more students.

==== Full Accreditation Refresh
This approach will delete all existing accreditations in the `StudentAccreditations` table.

It will then re-calculate all accreditations for all students based on their existing course completions.

. SSH into GPTE Reporting operating as the `jboss` operating system user.
. Change directories to OPEN_Reporting
. Ensure that `accred-process` JVM is running.
. Execute:
+
-----
./bin/accreditation_batch_evaluation.sh -env=[prod | dev]
-----

==== Focused Accreditation Refresh

. Invoke accreditation logic on an existing student whose course completions should lead to an accreditation
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "IDENTIFY_FIRED_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                http://$HOSTNAME:9090/gpte_accreditation/students/10387
-----

. Invoke accreditation logic on a non existent student
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "IDENTIFY_FIRED_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                http://$HOSTNAME:9090/gpte_accreditation/students/103899
-----

. Invoke accreditation logic on all students whose studentid > 10000 and < 11000
+
-----
curl -v -X PUT  -H "ACCEPT: application/json" \
                -H "IDENTIFY_FIRED_RULES_ONLY: true" \
                -H "RESPOND_JSON: true" \
                -H "LOW_STUDENT_ID: 10000" \
                -H "HIGH_STUDENT_ID: 11000" \
                http://$HOSTNAME:9090/gpte_accreditation/students/batch
-----

== SkillsBase Integration

. Check # of Red Hat associates whose accreds need to be pushed to SkillsBase
+
-----
MariaDB [lms_transactional]> select count(sa.studentId) from StudentAccreditations sa, Students s where sa.Processed=0 and s.StudentId=sa.StudentID and s.email like "%redhat.com";
-----

. Prepare for end-to-end test using only student = gpse.training+1@redhat.com
+
-----
MariaDB [lms_transactional]>  update StudentAccreditations sa, Students s set sa.Processed=1 where s.StudentId=sa.StudentID and s.email like "%redhat.com";
MariaDB [lms_transactional]>  update StudentAccreditations sa, Students s set sa.Processed=0 where s.StudentId=sa.StudentID and s.email="gpse.training+1@redhat.com";
MariaDB [lms_transactional]>  update Students set SkillsbaseStatus=1 where Email like "%redhat.com";
MariaDB [lms_transactional]>  update Students set SkillsbaseStatus=0 where Email="gpse.training+1@redhat.com";

properties/dev.properties :  
    sb_sendMailToStudentEnabled=true
    accred_process-push-qualification-to-skillsbase-batch=quartz2://accred_process-push-qualifications-to-skillsbase?cron=0 0/5 * 1/1 * ? *

ba
ta
-----


ifdef::showscript[]

=== activemq-artemis install

NOTE:  artemis is not yet used.  Disregard this section

-----
# sudo yum install -y libaio-devel
# sudo su - jboss
$ cd /opt
$ git clone https://github.com/apache/activemq-artemis.git
$ cd activemq-artemis
$ mvn -Prelease install -DskipTests
$ cd artemis-distribution/target/apache-artemis-1.4.0-SNAPSHOT-bin/apache-artemis-1.4.0-SNAPSHOT
-----

endif::showscript[]
